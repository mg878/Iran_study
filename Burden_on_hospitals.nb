(* this code is based on the model developed by Neher lab: https://covid19-scenarios.org/ *)
(* for more information about the code and model, please visit the following github ripository: https://github.com/neherlab/covid19_scenarios *)


plth = {};
pltc = {};
pltcase = {};
pltdeath = {};
pltcd = {};
maxinf = {};
maxinftime = {};
totdeath = {};
rt = {};
maxicu = {};
maxicutime = {};
opac = 0.1;
For[r0 = 0, r0 <= 1.5, r0 += 0.5, 
 For[u = 0, u <= 8, u += 2, 
  For[k = 0, k <= 0.4, k += 0.2, 
   For[p = 0, p <= 0.4, p += 0.2, 
    For[o = 0, o <= 0.4, o += 0.2, eqs = {};
     start = {2020, 1, 1};
     m = 1 - {0.1, 0.3, 1.2, 3.2, 4.9, 10.2, 16.6, 24.3, 27.3}*10^-2;
     cc = {5, 5, 5, 5, 6.3, 12.2, 27.4, 43.2, 70.9}*10^-2;
     f = {30, 30, 30, 30, 40, 40, 50, 50, 50}*10^-2;
     isolateTime[x_, t_] :=
      Piecewise[{{1, 
         t < DaysBetween[start, {2020, 2, 20}] && x == 1}, {0.7 - o, 
         t >= DaysBetween[start, {2020, 2, 20}] && x == 1},
        {1, 
         t < DaysBetween[start, {2020, 2, 20}] && x == 2}, {0.7 - o, 
         t >= DaysBetween[start, {2020, 2, 20}] && x == 2},
        {1, 
         t < DaysBetween[start, {2020, 2, 20}] && x == 3}, {0.7 - o, 
         t >= DaysBetween[start, {2020, 2, 20}] && x == 3},
        {1, t < DaysBetween[start, {2020, 2, 20}] && x == 4}, {1 - p, 
         t >= DaysBetween[start, {2020, 2, 20}] && x == 4},
        {1, t < DaysBetween[start, {2020, 2, 20}] && x == 5}, {1 - p, 
         t >= DaysBetween[start, {2020, 2, 20}] && x == 5},
        {1, t < DaysBetween[start, {2020, 2, 20}] && x == 6}, {1 - p, 
         t >= DaysBetween[start, {2020, 2, 20}] && x == 6},
        {1, 
         t < DaysBetween[start, {2020, 2, 20}] && x == 7}, {0.9 - k, 
         t >= DaysBetween[start, {2020, 2, 20}] && x == 7},
        {1, 
         t < DaysBetween[start, {2020, 2, 20}] && x == 8}, {0.9 - k, 
         t >= DaysBetween[start, {2020, 2, 20}] && x == 8},
        {1, 
         t < DaysBetween[start, {2020, 2, 20}] && x == 9}, {0.9 - k, 
         t >= DaysBetween[start, {2020, 2, 20}] && x == 9}}];
     R0 = 4.5 + r0;
     tl = 4;
     ti = 5;
     th = 8;
     tc = 10;
     \[Beta][t_] := 
      R0*Piecewise[{{1, t < DaysBetween[start, {2020, 2, 20}]}, {0.8, 
           DaysBetween[start, {2020, 2, 20}] <= t < 
            DaysBetween[start, {2020, 3, 5}]}, {0.4, 
           DaysBetween[start, {2020, 3, 5}] <= t < 
            DaysBetween[start, {2020, 4, 15}]}, {0.5, 
           t >= DaysBetween[start, {2020, 4, 15}]}}]/ti;
     n = 75103347;
     demog = {11890343, 12278478, 17087151, 12542942, 8937230, 
       6207527, 3206638, 2033499, 919539};
     initialS = Table[s[i][0] == demog[[i]], {i, 1, 9}];
     initialE1 = Table[e1[i][0] == 0, {i, 1, 9}];
     initialE2 = Table[e2[i][0] == 0, {i, 1, 9}];
     initialE3 = Table[e3[i][0] == 3/9, {i, 1, 9}];
     initialInf = Table[w[i][0] == 0, {i, 1, 9}];
     initialH = Table[h[i][0] == 0, {i, 1, 9}];
     initialC = Table[c[i][0] == 0, {i, 1, 9}];
     initialR = Table[r[i][0] == 0, {i, 1, 9}];
     initialD = Table[d[i][0] == 0, {i, 1, 9}];
     import[t_] := Piecewise[{{0.01, t < 50}, {0, t >= 50}}];
     eqs1 = 
      Table[s[i]'[
         t] == -\[Beta][t] isolateTime[i, t] n^-1 s[i][
          t] (Sum[w[j][t], {j, 1, 9}]), {i, 1, 9}];
     eqs2 = 
      Table[e1[i]'[
         t] == \[Beta][t] isolateTime[i, t] n^-1 s[i][
           t] (Sum[w[j][t], {j, 1, 9}]) - 3 e1[i][t]/tl, {i, 1, 9}];
     eqs3 = 
      Table[e2[i]'[t] == 3 e1[i][t]/tl - 3 e2[i][t]/tl, {i, 1, 9}];
     eqs4 = 
      Table[e3[i]'[t] == 3 e2[i][t]/tl - 3 e3[i][t]/tl, {i, 1, 9}];
     eqs5 = Table[w[i]'[t] == 3 e3[i][t]/tl - w[i][t]/ti, {i, 1, 9}];
     eqs6 = 
      Table[h[i]'[
         t] == (1 - m[[i]]) w[i][t]/ti - (1 - f[[i]]) c[i][t]/tc - 
         h[i][t]/th, {i, 1, 9}];
     eqs7 = 
      Table[c[i]'[t] == cc[[i]] h[i][t]/th - c[i][t]/tc, {i, 1, 9}];
     eqs8 = 
      Table[r[i]'[t] == 
        m[[i]] w[i][t]/ti + (1 - cc[[i]]) h[i][t]/th, {i, 1, 9}];
     eqs9 = Table[d[i]'[t] == f[[i]] c[i][t]/tc, {i, 1, 9}];
     sol = 
      NDSolve[Join[
        Flatten[{eqs1, eqs2, eqs3, eqs4, eqs5, eqs6, eqs7, eqs8, 
          eqs9}], Flatten[{initialS,
          initialE1, initialE2, initialE3, initialInf, initialH, 
          initialC, initialR, initialD}]], 
       Join[Table[s[i], {i, 1, 9}], Table[e1[i], {i, 1, 9}], 
        Table[e2[i], {i, 1, 9}], Table[e3[i], {i, 1, 9}], 
        Table[w[i], {i, 1, 9}], Table[h[i], {i, 1, 9}], 
        Table[c[i], {i, 1, 9}], Table[r[i], {i, 1, 9}], 
        Table[d[i], {i, 1, 9}]], {t, 0 - u, 1000}];
      cumdeath = 
      Table[Table[(d[oo][t] /. sol /. t -> m)[[1]], {m, 0 - u, 400, 
         1}], {oo, 1, 9}];
     infectious = 
      Table[Table[(w[oo][t] /. sol /. t -> m)[[1]], {m, 0 - u, 400, 
         1}], {oo, 1, 9}];
      hospital = 
      Table[Table[(h[oo][t] /. sol /. t -> m)[[1]], {m, 0 - u, 400, 
         1}], {oo, 1, 9}];
     critical = 
      Table[Table[(c[oo][t] /. sol /. t -> m)[[1]], {m, 0 - u, 400, 
         1}], {oo, 1, 9}];
     AppendTo[plth, 
      ListLogPlot[{Table[{i, 98000}, {i, 1, 400}], Plus @@ hospital}, 
       PlotRange -> {{1, Automatic}, {1, Automatic}}, Joined -> True, 
       PlotStyle -> {Black, {Opacity[opac], Brown}}, 
       PlotTheme -> "Detailed", FrameStyle -> Directive[Black, 18], 
       FrameLabel -> {"Days since 1 January", 
         "Hospital beds required"}]];
     AppendTo[pltc, 
      ListLogPlot[{Table[{i, 3790}, {i, 1, 400}], Plus @@ critical}, 
       PlotRange -> {{1, Automatic}, {1, Automatic}}, Joined -> True, 
       PlotStyle -> {Black, {Opacity[opac], Red}}, 
       PlotTheme -> "Detailed", FrameStyle -> Directive[Black, 18], 
       FrameLabel -> {"Days since 1 January", "ICU beds required"}]];
     AppendTo[pltcd, 
      ListLogPlot[{Plus @@ infectious, Plus @@ cumdeath}, 
       PlotRange -> {{1, Automatic}, {1, Automatic}}, Joined -> True, 
       PlotStyle -> {{Opacity[opac], Orange}, {Opacity[opac], Blue}}, 
       PlotTheme -> "Detailed", FrameStyle -> Directive[Black, 18], 
       FrameLabel -> {"Days since 1 January", 
         "Number of individuals"}]];
     ];
    AppendTo[maxinf, Max[Plus @@ infectious]];
    AppendTo[maxinftime, 
     Position[Plus @@ infectious, Max[Plus @@ infectious]][[1, 1]]];
    AppendTo[maxicu, Max[Plus @@ critical]];
    AppendTo[maxicutime, 
     Position[Plus @@ critical, Max[Plus @@ critical]][[1, 1]]];
    AppendTo[totdeath, (Plus @@ cumdeath)[[-1]]];
    ]]]]

BoxWhiskerChart[{totdeath, maxicu, 
  maxinf}, {{"Fences", Black}, {"Whiskers", Black}}, 
 ChartStyle -> {Lighter[Blue, 0.3], Lighter[Red, 0.3], 
   Lighter[Orange, 0.3]}, FrameStyle -> Directive[Black, 18], 
 ScalingFunctions -> "Log", 
 ChartLabels -> {"Total deaths", "Peak ICU beds required", 
   "Cases in peak week"}, 
 FrameLabel -> {{"Number of individuals", None}, {"", None}}]

BoxWhiskerChart[{maxinftime, 
  maxicutime}, {{"Fences", Black}, {"Whiskers", Black}}, 
 ChartStyle -> {Lighter[Orange, 0.3], Lighter[Red, 0.3], 
   Lighter[Orange, 0.3]}, FrameStyle -> Directive[Black, 18], 
 ScalingFunctions -> "Log", 
 ChartLabels -> {"Peak case time", "Peak ICU required time"}, 
 FrameLabel -> {{"Days since 1 January", None}, {"", None}}]

Show[Table[plth[[i]], {i, 1, Length[pltc]}], PlotRange -> All]

Show[Table[pltc[[i]], {i, 1, Length[plth]}], PlotRange -> All]

pl = Show[Table[pltcd[[i]], {i, 1, Length[pltc]}], 
  PlotRange -> {{2, Automatic}, {2, Automatic}}]

Needs["Calendar`"]

start = {2020, 1, 1};

isolateTime[x_, t_] :=
 Piecewise[{{1, 
    t < DaysBetween[start, {2020, 2, 20}] && x == 1}, {0.5, 
    t >= DaysBetween[start, {2020, 2, 20}] && x == 1},
   {1, t < DaysBetween[start, {2020, 2, 20}] && x == 2}, {0.5, 
    t >= DaysBetween[start, {2020, 2, 20}] && x == 2},
   {1, t < DaysBetween[start, {2020, 2, 20}] && x == 3}, {0.5, 
    t >= DaysBetween[start, {2020, 2, 20}] && x == 3},
   {1, t < DaysBetween[start, {2020, 2, 20}] && x == 4}, {0.8, 
    t >= DaysBetween[start, {2020, 2, 20}] && x == 4},
   {1, t < DaysBetween[start, {2020, 2, 20}] && x == 5}, {0.8, 
    t >= DaysBetween[start, {2020, 2, 20}] && x == 5},
   {1, t < DaysBetween[start, {2020, 2, 20}] && x == 6}, {0.8, 
    t >= DaysBetween[start, {2020, 2, 20}] && x == 6},
   {1, t < DaysBetween[start, {2020, 2, 20}] && x == 7}, {0.7, 
    t >= DaysBetween[start, {2020, 2, 20}] && x == 7},
   {1, t < DaysBetween[start, {2020, 2, 20}] && x == 8}, {0.7, 
    t >= DaysBetween[start, {2020, 2, 20}] && x == 8},
   {1, t < DaysBetween[start, {2020, 2, 20}] && x == 9}, {0.7, 
    t >= DaysBetween[start, {2020, 2, 20}] && x == 9}}]

cursed = Flatten[
   Table[{t, 
     r *Piecewise[{{1, t < DaysBetween[start, {2020, 2, 20}]}, {0.8, 
         DaysBetween[start, {2020, 2, 20}] <= t < 
          DaysBetween[start, {2020, 3, 5}]}, {0.4, 
         DaysBetween[start, {2020, 3, 5}] <= t < 
          DaysBetween[start, {2020, 4, 15}]}, {0.5, 
         t >= DaysBetween[start, {2020, 4, 15}]}}]*
      isolateTime[j, t]}, {r, 4.5, 6, .5}, {j, 1, 9}, {t, 1, 200, 1}],
    1];

ListPlot[cursed, PlotRange -> All, Joined -> True, PlotStyle -> Gray, 
 PlotTheme -> "Detailed", FrameStyle -> Directive[Black, 18], 
 FrameLabel -> {"Days since 1 January", "R(t)"}]